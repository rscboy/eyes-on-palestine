<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="https://i.postimg.cc/fT81SwN0/426559D6-9EF9-49AA-8A0B-84A3FA70B3E2.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submission Form - Echoes of Gaza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fonts: Playfair Display (Headings), Lora (Body/Text), Inter (Fallback) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@400;600;700&family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- Global Branding System --- */
        
        :root {
            --bg-primary: #0a0a0a;   /* Deep black/near-black */
            --bg-secondary: #141414; /* Very dark charcoal */
            --text-primary: #E0E0E0; /* Off-white */
            --text-secondary: #888888; /* Muted gray */
            --border-color: #333333;
            --accent-red: #8B0000;   /* Deep, restrained red */
            --focus-red: #D90000;
        }

        body {
            font-family: 'Lora', serif; /* Archival/Editorial body font */
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
        }

        h1, h2, h3, h4, .editorial-font {
            font-family: 'Playfair Display', serif;
        }

        /* --- Form Elements (Restrained, Rectangular, No "Card" look) --- */
        
        /* Removed .form-container styles (no card, no shadow, no rounded corners) */
        
        .form-input, .form-select {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: #FFFFFF;
            border-radius: 0; /* Sharp edges */
            font-family: 'Lora', serif;
            transition: border-color 0.2s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--focus-red);
            box-shadow: none; /* No glow */
        }
        
        /* Placeholder styling */
        ::placeholder {
            color: #555;
            font-style: italic;
        }

        /* --- Buttons (Administrative, Minimal) --- */
        
        .btn-submit {
            background-color: #222; /* Neutral administrative dark */
            color: #E0E0E0;
            border: 1px solid #444;
            border-radius: 0; /* Sharp edges */
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 0.85rem;
            font-weight: 600;
            padding-top: 1rem;
            padding-bottom: 1rem;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif; /* Clean sans for interface elements */
        }

        .btn-submit:hover {
            background-color: var(--accent-red);
            border-color: var(--accent-red);
            color: #FFF;
        }

        .btn-submit:disabled {
            background-color: #111;
            border-color: #222;
            color: #444;
            cursor: not-allowed;
        }

        /* --- Tabs --- */
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 3rem;
        }
        
        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            margin-right: 1rem;
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
        }
        
        .tab-btn.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent-red);
        }

        /* --- Typography Details --- */

        .section-header {
            font-family: 'Playfair Display', serif;
            color: #FFF;
            border-bottom: 1px solid #333;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-weight: 400; /* Lighter weight for elegance */
            letter-spacing: 0.02em;
        }

        .note-block {
            background-color: transparent; /* No blocky background */
            border-left: 1px solid var(--accent-red); /* Thin accent line */
            padding-left: 1rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* --- Messages --- */
        
        .alert-message {
            display: none;
            padding: 1rem;
            border-radius: 0; /* Sharp */
            margin-bottom: 1.5rem;
            text-align: center;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            border: 1px solid;
        }

        .alert-success {
            background-color: #051b05;
            color: #a3d9a3;
            border-color: #1b4d1b;
        }

        .alert-error {
            background-color: #1f0505;
            color: #d9a3a3;
            border-color: #4d1b1b;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header / Logo Section -->
    <!-- Positioned normally in flow with generous padding to avoid overlap -->
    <header class="w-full pt-8 pb-8 px-6 md:px-16 lg:px-24">
        <a href="https://echoesofgaza.org" class="no-underline hover:opacity-70 transition-opacity duration-300 inline-block">
            <h1 class="text-lg text-white font-bold tracking-widest uppercase" style="font-family: 'Playfair Display', serif;">
                Echoes of Gaza
            </h1>
        </a>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-3xl mx-auto px-6 md:px-8 pb-24">
        
        <!-- Introduction Text -->
        <div class="mb-12">
            <!-- Removed the large "Form Card" wrapper to follow "No cards" rule -->
            <p class="text-lg md:text-xl text-gray-200 mb-6 font-serif leading-relaxed">
                This is a Gaza genocide collaborative. Submit articles that document the ongoing genocide, ethnic cleansing, displacement, dehumanization, and subjugation of the Palestinian people.
            </p>
            
            <div class="note-block text-sm">
                <p class="font-semibold text-gray-400 uppercase tracking-wider text-xs mb-2 not-italic font-sans">Note on Contribution</p>
                <p>
                    This is an open-source project. Contributions are curated from individuals from the collective based on a history of acting in good faith toward Palestinian liberation. All submissions will be reviewed to ensure they align with the mission of Echoes of Gaza.
                </p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tab-container">
            <button id="tab-articles" class="tab-btn active" onclick="switchTab('articles')">Article Submission</button>
            <button id="tab-primary" class="tab-btn" onclick="switchTab('primary')">Primary Source Submission</button>
        </div>

        <!-- Article Form Container -->
        <div id="content-articles">
            <form id="submissionForm" class="space-y-12">
                    
                <!-- Required Fields -->
                <section>
                    <h3 class="section-header text-xl">Required Information</h3>
                    
                    <div class="space-y-6"> <!-- Increased spacing for "generous margins" -->
                        <div>
                            <label for="submitterName" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Your Name *</label>
                            <input type="text" id="submitterName" name="submitterName" class="form-input block w-full p-3" placeholder="Identify yourself for our records" required>
                        </div>
                        
                        <div>
                            <label for="date" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Date of Article *</label>
                            <input type="date" id="date" name="date" class="form-input block w-full p-3" required>
                        </div>
                        
                        <div>
                            <label for="title" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Article Title *</label>
                            <input type="text" id="title" name="title" class="form-input block w-full p-3" placeholder="Enter the exact headline" required>
                        </div>
                        
                        <div>
                            <label for="link" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Article URL *</label>
                            <input type="url" id="link" name="link" class="form-input block w-full p-3" placeholder="https://" required>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="source" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Source Name *</label>
                                <input type="text" id="source" name="source" class="form-input block w-full p-3" placeholder="Publication Name" required>
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Category *</label>
                                <select id="category" name="category" class="form-select block w-full p-3 cursor-pointer" required>
                                    <option value="" disabled selected>Select a classification</option>
                                    <!-- Categories will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Optional Fields -->
                <section>
                    <h3 class="section-header text-xl">Optional Documentation</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label for="summary" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Neutral Summary</label>
                            <textarea id="summary" name="summary" rows="5" class="form-input block w-full p-3" placeholder="Provide a brief, objective summary of the content."></textarea>
                        </div>
                        <div>
                            <label for="imageUrl" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Image URL</label>
                            <input type="url" id="imageUrl" name="imageUrl" class="form-input block w-full p-3" placeholder="Link to relevant imagery">
                        </div>
                    </div>
                </section>

                <!-- Submit Button & Messages -->
                <div class="pt-8 border-t border-neutral-900">
                    <!-- Submission Status Messages -->
                    <div id="successMessage" class="alert-message alert-success">
                        RECORD SUBMITTED. THANK YOU FOR YOUR CONTRIBUTION.
                    </div>
                    <div id="errorMessage" class="alert-message alert-error">
                        SUBMISSION FAILED. PLEASE VERIFY DATA AND RETRY.
                    </div>

                    <button type="button" id="submitButton" class="btn-submit w-full">
                        Submit Record to Archive
                    </button>
                    <p id="submittingText" class="text-xs text-center text-gray-600 mt-4 font-sans tracking-widest uppercase" style="display: none;">
                        Processing Submission...
                    </p>
                </div>
            </form>
        </div>

        <!-- Primary Source Content -->
        <div id="content-primary" class="hidden">
            <form id="primarySourceForm" class="space-y-12">
                <!-- Section: File Upload -->
                <section>
                    <h3 class="section-header text-xl">Document Upload</h3>
                    
                    <div class="space-y-6">
                        <!-- File Input -->
                        <div>
                            <label for="primaryFile" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Select File *</label>
                            <input type="file" id="primaryFile" name="primaryFile" class="block w-full text-sm text-gray-400
                                file:mr-4 file:py-3 file:px-4
                                file:rounded-none file:border-0
                                file:text-sm file:font-semibold
                                file:bg-[#222] file:text-gray-300
                                hover:file:bg-[#8B0000] hover:file:text-white
                                transition-all duration-300
                                border border-[#333] bg-[#141414] p-2" required>
                        </div>

                        <!-- Video Instructions -->
                        <div class="note-block text-sm">
                            <p class="font-semibold text-gray-400 uppercase tracking-wider text-xs mb-2 not-italic font-sans">Video Submission Instructions</p>
                            <p>
                                For video files larger than 500MB, or for secure anonymous transfer of high-resolution footage, please use an encrypted transfer service (like WeTransfer or Signal) and paste the download link in the "Neutral Summary" field of the Standard Article form, or contact us directly.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Section: Metadata -->
                <section>
                    <h3 class="section-header text-xl">Source Details</h3>
                    
                    <div class="space-y-6">
                        <div>
                             <label for="primaryTitle" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Title of Information *</label>
                             <input type="text" id="primaryTitle" name="primaryTitle" class="form-input block w-full p-3" placeholder="Descriptive title of the document/media" required>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="primaryDate" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Date *</label>
                                <input type="date" id="primaryDate" name="primaryDate" class="form-input block w-full p-3" required>
                            </div>
                            <div>
                                 <label for="primaryTag" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Tag *</label>
                                 <input type="text" id="primaryTag" name="primaryTag" class="form-input block w-full p-3" placeholder="e.g. Medical Report, Eye Witness" required>
                            </div>
                        </div>

                        <div>
                            <label for="primarySource" class="block text-sm font-sans text-gray-500 mb-2 uppercase tracking-wide">Source (Optional)</label>
                            <input type="text" id="primarySource" name="primarySource" class="form-input block w-full p-3" placeholder="Original source or author if known">
                        </div>
                    </div>
                </section>

                <!-- Section: Legal -->
                <section>
                    <h3 class="section-header text-xl">Verification & Terms</h3>
                    <div class="space-y-4 pt-4">
                        
                        <label class="flex items-start gap-4 cursor-pointer group">
                            <div class="relative flex items-center">
                                <input type="checkbox" required class="peer h-5 w-5 cursor-pointer appearance-none border border-gray-600 bg-[#141414] checked:border-red-900 checked:bg-red-900 transition-all">
                                <svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none opacity-0 peer-checked:opacity-100 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                            <div class="text-sm text-gray-400 group-hover:text-gray-300 transition-colors">
                                <span class="block font-bold text-gray-300 mb-1">Authenticity Verification</span>
                                I certify that this content is authentic, not AI-generated, and accurately represents the events or data depicted.
                            </div>
                        </label>

                        <label class="flex items-start gap-4 cursor-pointer group">
                            <div class="relative flex items-center">
                                <input type="checkbox" required class="peer h-5 w-5 cursor-pointer appearance-none border border-gray-600 bg-[#141414] checked:border-red-900 checked:bg-red-900 transition-all">
                                <svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none opacity-0 peer-checked:opacity-100 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                            <div class="text-sm text-gray-400 group-hover:text-gray-300 transition-colors">
                                <span class="block font-bold text-gray-300 mb-1">Intellectual Property Rights</span>
                                I confirm I have the right to share this content or it is in the public domain. I grant Echoes of Gaza permission to archive and display this material.
                            </div>
                        </label>

                        <label class="flex items-start gap-4 cursor-pointer group">
                            <div class="relative flex items-center">
                                <input type="checkbox" required class="peer h-5 w-5 cursor-pointer appearance-none border border-gray-600 bg-[#141414] checked:border-red-900 checked:bg-red-900 transition-all">
                                <svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none opacity-0 peer-checked:opacity-100 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                            <div class="text-sm text-gray-400 group-hover:text-gray-300 transition-colors">
                                <span class="block font-bold text-gray-300 mb-1">Limitation of Liability</span>
                                I understand and accept the terms regarding the limitation of liability for the Echoes of Gaza platform.
                            </div>
                        </label>

                    </div>
                </section>

                <!-- Submit Button (Primary) -->
                <div class="pt-8 border-t border-neutral-900">
                    <button type="button" id="submitPrimaryButton" class="btn-submit w-full">
                        Upload Primary Source
                    </button>
                    <!-- Placeholder for status messages -->
                    <p class="text-xs text-center text-gray-600 mt-4 font-sans tracking-widest uppercase">
                        Secure Upload Ready
                    </p>
                </div>
            </form>
        </div>

    </main>

    <!-- Footer -->
    <footer class="w-full py-8 text-center border-t border-neutral-900 mt-auto">
        <p class="text-xs text-gray-600 font-sans tracking-widest uppercase mb-2">
            &copy; 2026 Echoes of Gaza
        </p>
        <a href="https://echoesofgaza.org" class="text-xs text-gray-500 hover:text-white transition-colors font-serif italic">
            Return to Archive
        </a>
    </footer>

    <script>
        // --- Tab Switching Logic ---
        function switchTab(tabName) {
            const tabArticles = document.getElementById('tab-articles');
            const tabPrimary = document.getElementById('tab-primary');
            const contentArticles = document.getElementById('content-articles');
            const contentPrimary = document.getElementById('content-primary');

            if (tabName === 'articles') {
                tabArticles.classList.add('active');
                tabPrimary.classList.remove('active');
                contentArticles.classList.remove('hidden');
                contentPrimary.classList.add('hidden');
            } else {
                tabArticles.classList.remove('active');
                tabPrimary.classList.add('active');
                contentArticles.classList.add('hidden');
                contentPrimary.classList.remove('hidden');
            }
        }


        // List of all categories, cleaned and sorted
        const categories = [
            "Accountability", "Aid Access", "Aid blockade", "Aid conflict", "Aid crisis",
            "Aid disaster", "Aid Disruption", "Aid policy", "Aid Targeting", "Analysis",
            "Antisemitism", "Civilian Casualties", "Conflict", "Conflict / Human Stories",
            "Conflict / Humanitarian", "Conflict and Destruction", "Conflict and Displacement",
            "Conflict escalation", "Conflict Reporting", "Crisis", "Culture", "Death Toll",
            "Destruction Plans", "Detention & Rights", "Diplomacy", "Economic Crisis",
            "Environment", "Ethnic Cleansing", "Extreme Rhetoric", "Famine crisis",
            "Forced Displacement", "Foreign Policy", "Gaza Policy", "Genocide",
            "Genocide Accusations", "Genocide Allegation", "Genocide Allegations",
            "Genocide Analysis", "Health", "Health / Starvation", "Healthcare Crisis",
            "Hostage Testimony", "Human interest", "Human Rights", "Human Shields",
            "Humanitarian", "Humanitarian Aid", "Humanitarian Crisis", "Humanitarian aid",
            "Hunger Crisis", "Illegal Expansion", "Illegal Weaponry", "Incitement",
            "Intelligence", "International Appeal", "Israeli Politics", "Legal",
            "Legal Proceedings", "Living Conditions", "Media", "Media & Conflict",
            "Media Coverage", "Media Restrictions", "Media Rights", "Media ethics",
            "Medical Testimony", "Military", "Military Criticism", "Military Operations",
            "Military Plans", "Military Technology", "Military policy", "Opinion",
            "Opinion / Human Rights", "Political Controversy", "Political Criticism",
            "Political Discourse", "Political Statements", "Politics", "Press Freedom",
            "Press freedom", "Prison Conditions", "Protests", "Psychological Warfare",
            "Public Opinion",
            "Rhetoric", "Rights & Justice", "Rules of Engagement",
            "Security / Diplomacy", "Settler Violence", "Sexual Violence", "Social Impact",
            "Sports", "Sports & Conflict", "Starvation", "Starvation Warning",
            "Targeting Civilians", "Targeting Healthcare", "Targeting Religious Sites",
            "Technology", "Transfer Support", "U.S. Politics", "UN Reports", "UN Warnings",
            "War Crimes", "War Objectives", "West Bank Violence", "analysis", "conflict",
            "diplomacy", "human rights", "humanitarian crisis"
        ].sort();

        // Populate category dropdown
        const categorySelect = document.getElementById('category');
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

        // Color palette for categories (17 colors)
        const colors = [
            "#FF6B6B", "#4ECDC4", "#45B7D1", "#F9C80E", "#FF8811",
            "#F0E68C", "#98D8C8", "#B5EAD7", "#FFB7B2", "#77DD77",
            "#A2D2FF", "#C7CEEA", "#F3A683", "#F194B4", "#83D6E3",
            "#E0BBE4", "#D6EAF8"
        ];

        /**
         * Simple hash function to get a consistent index from a string.
         */
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash);
        }

        /**
         * Gets a consistent color from the palette based on the category name.
         */
        function getCategoryColor(category) {
            const hash = simpleHash(category);
            const index = hash % colors.length;
            return colors[index];
        }

        // Get form elements
        const form = document.getElementById('submissionForm');
        const submitButton = document.getElementById('submitButton');
        const submittingText = document.getElementById('submittingText');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // Handle form submission
        submitButton.addEventListener('click', function(event) {
            // Manually check validity
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Disable button and show loading text
            submitButton.disabled = true;
            submittingText.style.display = 'block';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            // Get form data
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Get the assigned color
            const categoryColor = getCategoryColor(data.category);

            // Create JSON object for the Google Script
            const jsonObject = {
                submitted_by: data.submitterName,
                date: data.date,
                title: data.title,
                summary: data.summary || "",
                link: data.link,
                imageUrl: data.imageUrl || "https://placehold.co/600x400/2C2C2C/E0E0E0?text=No+Image", // Default placeholder
                category: data.category,
                categoryColor: categoryColor,
                source: data.source
            };

            // --- THIS IS THE UPDATED PART ---
            // Your Google Apps Script Web App URL
            const googleScriptWebAppUrl = 'https://script.google.com/macros/s/AKfycbyBnG6OCnoSwDea9fad4v6I2nx-7ioDa9uXCOY_0dbc6mmMcL5Nmiee7600fC4iH3Dj/exec';

            fetch(googleScriptWebAppUrl, {
                method: 'POST',
                // We send as text/plain, which Google Apps Script
                // will receive in e.postData.contents
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8', 
                },
                body: JSON.stringify(jsonObject) // Send the JSON object as a string
            })
            .then(response => response.json()) // Google Script returns JSON
            .then(data => {
                if (data.result === 'success') {
                    // Show success
                    successMessage.style.display = 'block';
                    form.reset();
                } else {
                    // Show error
                    errorMessage.style.display = 'block';
                }
            })
            .catch(error => {
                // Show error
                console.error('Fetch Error:', error);
                errorMessage.style.display = 'block';
            })
            .finally(() => {
                // Re-enable button and hide loading text
                submitButton.disabled = false;
                submittingText.style.display = 'none';
            });
        });

        // Set default date to today for both forms
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('date');
            if (dateInput) dateInput.value = today;
            
            const primaryDateInput = document.getElementById('primaryDate');
            if (primaryDateInput) primaryDateInput.value = today;
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import {
          getFirestore,
          collection,
          addDoc,
          serverTimestamp,
          updateDoc,
          doc
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import {
          getStorage,
          ref,
          uploadBytesResumable
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";
      
        // Firebase config (yours)
        const firebaseConfig = {
          apiKey: "AIzaSyDWpXfcX0T3ceI4zSe5hADkcundb3TqqeM",
          authDomain: "echoes-of-gaza.firebaseapp.com",
          projectId: "echoes-of-gaza",
          storageBucket: "echoes-of-gaza.firebasestorage.app",
          messagingSenderId: "592151003023",
          appId: "1:592151003023:web:b3c7db040a0afb87a555fa"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
      
        // Primary Source form elements
        const primaryForm = document.getElementById("primarySourceForm");
        const submitPrimaryButton = document.getElementById("submitPrimaryButton");
      
        // This is your placeholder status line under the primary submit button
        const primaryStatusEl = submitPrimaryButton?.parentElement?.querySelector("p");
      
        function setPrimaryStatus(message) {
          if (primaryStatusEl) primaryStatusEl.textContent = message;
        }
      
        function formatBytes(bytes) {
          if (!Number(bytes)) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KiB", "MiB", "GiB"];
          const i = Math.min(Math.floor(Math.log(bytes) / Math.log(k)), sizes.length - 1);
          return `${(bytes / Math.pow(k, i)).toFixed(i === 0 ? 0 : 2)} ${sizes[i]}`;
        }
      
        submitPrimaryButton.addEventListener("click", async () => {
          // Validate required fields and checkboxes
          if (!primaryForm.checkValidity()) {
            primaryForm.reportValidity();
            return;
          }
      
          const fileInput = document.getElementById("primaryFile");
          const file = fileInput?.files?.[0];
      
          if (!file) {
            alert("Please select a file.");
            return;
          }
      
          // Client side size cap (server side rules should also enforce)
          const ONE_GB = 1024 * 1024 * 1024;
          if (file.size > ONE_GB) {
            alert("File too large. Max size is 1GB.");
            return;
          }
      
          // Read metadata
          const title = document.getElementById("primaryTitle").value.trim();
          const date = document.getElementById("primaryDate").value; // YYYY-MM-DD
          const tag = document.getElementById("primaryTag").value.trim();
          const source = document.getElementById("primarySource").value.trim();
      
          submitPrimaryButton.disabled = true;
          setPrimaryStatus("Creating record...");
      
          try {
            // 1) Create Firestore doc first to get submissionId
            const docRef = await addDoc(collection(db, "primary_sources"), {
              status: "pending",
              createdAt: serverTimestamp(),
      
              // Fields your admin and public pages expect
              title,
              date,
              tag,
              source: source || "",
      
              originalFileName: file.name,
              contentType: file.type || "",
              sizeBytes: file.size
            });
      
            const submissionId = docRef.id;
      
            // 2) Upload file to Storage under pending path
            const storagePath = `primary_sources/pending/${submissionId}/${file.name}`;
            const storageRef = ref(storage, storagePath);
      
            setPrimaryStatus(`Uploading ${formatBytes(file.size)}...`);
      
            const uploadTask = uploadBytesResumable(storageRef, file, {
              contentType: file.type || undefined
            });
      
            await new Promise((resolve, reject) => {
              uploadTask.on(
                "state_changed",
                (snap) => {
                  const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
                  setPrimaryStatus(`Uploading... ${pct}%`);
                },
                reject,
                resolve
              );
            });
      
            // 3) Store the storage path on the doc
            await updateDoc(doc(db, "primary_sources", submissionId), {
              storagePath
            });
      
            primaryForm.reset();
            setPrimaryStatus("Submitted. Pending admin approval.");
            alert("Submitted. Pending admin approval.");
      
          } catch (err) {
            console.error(err);
            const msg = err?.code ? `${err.code}: ${err.message}` : (err?.message || String(err));
            setPrimaryStatus("Upload failed: " + msg);
            alert("Upload failed: " + msg);
          } finally {
            submitPrimaryButton.disabled = false;
          }
        });
      </script>
</body>
</html>
