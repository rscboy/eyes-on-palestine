<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Primary Sources | Echoes of Gaza</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,500;1,400&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://i.postimg.cc/fT81SwN0/426559D6-9EF9-49AA-8A0B-84A3FA70B3E2.png" type="image/png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'void': '#0a0a0a',       // Near black background
                        'bone': '#e5e5e5',       // Soft off-white text
                        'ash': '#a3a3a3',        // Muted secondary text
                        'blood': '#7f1d1d',      // Muted red accent
                        'charcoal': '#171717',   // Input background
                        'border-dim': '#262626' // Subtle borders
                    },
                    fontFamily: {
                        'heading': ['"Playfair Display"', 'serif'],
                        'body': ['"Lora"', 'serif'],
                        'ui': ['"Inter"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom scrollbar for a raw, archival feel */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0a0a0a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #262626; 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #404040; 
        }
        
        /* Remove default input focus rings, replace with sharp border */
        input:focus, select:focus {
            outline: none;
            border-color: #525252;
        }

        /* Ensure iframes do not flash white */
        iframe {
            background-color: #0a0a0a;
        }

        /* Navigation Styles */
        .nav-glass {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            height: 80px; /* Fixed height for alignment */
        }
        
        .nav-link {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500;
            letter-spacing: 0.05em;
            color: #a3a3a3; /* text-ash */
            transition: color 0.2s ease;
            text-transform: uppercase;
        }
        
        .nav-link:hover {
            color: #ffffff;
        }

        .btn-primary {
            background-color: #7f1d1d; /* blood */
            color: white;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #601414;
        }
    </style>
</head>
<body class="bg-void text-bone min-h-screen font-body selection:bg-blood selection:text-white antialiased">

    <!-- Global Header -->
    <header class="nav-glass fixed w-full top-0 z-50 flex items-center">
        <div class="max-w-7xl mx-auto px-6 lg:px-8 w-full">
            <div class="flex justify-between items-center h-full">
                <!-- Updated link to echoesofgaza.org -->
                <a href="https://echoesofgaza.org" id="nav-logo" class="flex flex-col items-start opacity-80 hover:opacity-100 transition-opacity">
                    <span class="text-xs font-serif text-white tracking-[0.2em] uppercase">Echoes of Gaza</span>
                </a>

                <nav class="hidden md:flex items-center space-x-8">
                    <div class="relative group">
                        <button id="archive-menu-button" class="nav-link flex items-center">
                            Archive
                        </button>
                        <!-- Wrapper with top padding to bridge the hover gap -->
                        <div id="archive-menu-dropdown" class="absolute left-1/2 -translate-x-1/2 top-full pt-4 w-48 hidden group-hover:block z-50">
                            <div class="bg-[#0a0a0a] border border-[#222] shadow-2xl">
                                <a href="https://echoesofgaza.org/#articles" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Articles</a>
                                <a href="https://echoesofgaza.org/#books" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Books</a>
                                <a href="https://echoesofgaza.org/#videos" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Interviews</a>
                                <a href="https://echoesofgaza.org/#films" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Documentaries</a>
                            </div>
                        </div>
                    </div>

                    <div class="relative group">
                        <button id="tools-menu-button" class="nav-link flex items-center">
                            Tools
                        </button>
                        <div id="tools-menu-dropdown" class="absolute left-1/2 -translate-x-1/2 top-full pt-4 w-48 hidden group-hover:block z-50">
                            <div class="bg-[#0a0a0a] border border-[#222] shadow-2xl">
                                <a href="https://echoesofgaza.org/#narrative-test-section" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Narratives</a>
                                <a href="https://echoesofgaza.org/#casualty-graph" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Timeline</a>
                                <a href="https://echoesofgaza.org/#bias-tool-controls" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Racial Bias Tool</a>
                            </div>
                        </div>
                    </div>

                    <a href="https://echoesofgaza.org/#geolocation" class="nav-link">Maps</a>
                    <a href="https://echoesofgaza.org/#victims" class="nav-link">Victims</a>

                    <div class="relative group">
                        <button id="resources-menu-button" class="nav-link flex items-center">
                            Resources
                        </button>
                        <div id="resources-menu-dropdown" class="absolute left-1/2 -translate-x-1/2 top-full pt-4 w-48 hidden group-hover:block z-50">
                            <div class="bg-[#0a0a0a] border border-[#222] shadow-2xl">
                                <a href="https://echoesofgaza.org/#quotes" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Quotes & Resources</a>
                                <a href="https://echoesofgaza.org/events" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">Events</a>
                                <a href="https://echoesofgaza.org/#faq" class="block px-6 py-3 text-xs hover:bg-[#151515] transition text-gray-400 hover:text-white">FAQ</a>
                            </div>
                        </div>
                    </div>

                    <a href="https://echoesofgaza.org/collab" class="btn-primary px-5 py-2 rounded text-xs uppercase tracking-wider hidden md:block">
                        Submit Evidence
                    </a>
                </nav>
                
                <!-- MOBILE MENU BUTTON -->
                <div class="flex items-center space-x-4 md:hidden">
                    <button id="mobile-menu-button" class="text-gray-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <!-- Increased top padding from pt-24 to pt-32 -->
    <main class="max-w-3xl mx-auto px-6 pt-32 pb-16 md:pb-24">
        
        <!-- Header Section -->
        <header class="mb-10 text-center">
            <h1 class="font-heading text-3xl md:text-4xl lg:text-5xl font-semibold mb-6 text-white">Primary Sources</h1>
            
            <div class="max-w-xl mx-auto space-y-4 text-base leading-relaxed text-ash">
                <!-- Mobile Text -->
                <p class="md:hidden">
                    Documenting the genocide and ethnic cleansing of the Palestinian people. These records serve as unedited evidence.
                </p>
                <!-- Desktop Text -->
                <p class="hidden md:block">
                    This archive documents the genocide, ethnic cleansing, and systematic dehumanization of the Palestinian people. The records below serve as testimonial evidence. They are presented without editorial alteration to preserve the integrity of the witness accounts.
                </p>
            </div>

            <div class="mt-6 border-l-2 border-blood pl-4 text-left max-w-xl mx-auto">
                <p class="text-sm font-ui text-neutral-400">
                    <span class="text-blood font-semibold uppercase tracking-wider text-xs block mb-1">Archive Note</span>
                    <!-- Mobile Text -->
                    <span class="md:hidden">Verified records. Sensitive content warnings apply.</span>
                    <!-- Desktop Text -->
                    <span class="hidden md:inline">All records indexed here have been reviewed and approved for authenticity. Sensitive content warnings apply to the entirety of this collection.</span>
                </p>
            </div>
        </header>

        <!-- Controls Section -->
        <section class="mb-12 border-y border-border-dim py-6">
            <div class="flex flex-col md:flex-row gap-4">
                
                <!-- Search -->
                <div class="flex-grow">
                    <label for="searchInput" class="sr-only">Search archive</label>
                    <input type="text" id="searchInput" 
                        placeholder="Filter by title, tag, or source..." 
                        class="w-full bg-charcoal border border-border-dim text-bone px-4 py-3 font-ui text-sm placeholder-neutral-600 rounded-none focus:border-neutral-500 transition-colors">
                </div>

                <!-- Filters -->
                <div class="flex gap-4">
                    <select id="tagFilter" class="bg-charcoal border border-border-dim text-bone px-4 py-3 font-ui text-sm rounded-none cursor-pointer min-w-[140px]">
                        <option value="">All Tags</option>
                        <!-- Populated dynamically -->
                    </select>

                    <select id="sortFilter" class="bg-charcoal border border-border-dim text-bone px-4 py-3 font-ui text-sm rounded-none cursor-pointer min-w-[140px]">
                        <option value="newest">Newest Added</option>
                        <option value="oldest">Oldest Added</option>
                        <!-- Note: 'title' sort requires composite index with status, sticking to time based for MVP stability -->
                    </select>
                </div>
            </div>
        </section>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20 hidden">
            <span class="font-ui text-sm tracking-widest uppercase text-ash animate-pulse">Loading archive records...</span>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-20 hidden border border-border-dim border-dashed">
            <p class="font-heading text-xl text-neutral-500 italic">No approved primary sources are currently published.</p>
        </div>

        <!-- Records Grid -->
        <div id="recordsList" class="space-y-20">
            <!-- Records injected here -->
        </div>

        <!-- Pagination -->
        <div class="mt-20 text-center">
            <button id="loadMoreBtn" class="hidden font-ui text-sm uppercase tracking-widest border border-border-dim px-8 py-3 hover:bg-white hover:text-black transition-colors duration-300 rounded-none disabled:opacity-50 disabled:cursor-not-allowed">
                Load More Records
            </button>
        </div>

    </main>

    <!-- Footer -->
    <footer id="footer" class="bg-black border-t border-white/5 pt-12 pb-10">
        <div class="max-w-7xl mx-auto px-6 lg:px-8 flex flex-col md:flex-row justify-between gap-12">
            <div class="md:w-1/3 space-y-6">
                <div class="flex flex-col items-start opacity-70">
                    <span class="text-xs font-serif text-white tracking-[0.2em] uppercase">Echoes of Gaza</span>
                </div>
                <p class="text-gray-600 text-xs leading-relaxed">Preserving truth, resisting erasure.</p>
                <div id="google_translate_element"></div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-10 md:w-2/3">
                <div><h4 class="text-white/80 mb-6 text-xs uppercase tracking-widest">Archive</h4><ul class="space-y-3 text-xs text-gray-500"><li><a href="#articles" class="hover:text-white transition">Articles</a></li><li><a href="#victims" class="hover:text-white transition">Martyrs</a></li></ul></div>
                <div><h4 class="text-white/80 mb-6 text-xs uppercase tracking-widest">Resources</h4><ul class="space-y-3 text-xs text-gray-500"><li><a href="#quotes" class="hover:text-white transition">Quotes</a></li><li><a href="https://data.techforpalestine.org/api/v2/killed-in-gaza.min.json" target="_blank" class="hover:text-white transition">Raw Data</a></li></ul></div>
                <div><h4 class="text-white/80 mb-6 text-xs uppercase tracking-widest">Support</h4><div class="flex flex-col space-y-3"><a href="https://buymeacoffee.com/echoesofgaza" target="_blank" class="text-xs text-gray-500 hover:text-white transition">Donate</a><a href="https://www.patreon.com/c/EchoesofGaza" target="_blank" class="text-xs text-[#8B0000] hover:text-red-400 transition">Monthly Support</a></div></div>
            </div>
        </div>
        <div class="max-w-7xl mx-auto px-6 lg:px-8 mt-20 border-t border-white/5 pt-8 flex flex-col md:flex-row justify-between items-center text-[10px] text-gray-700 uppercase tracking-wider">
            <p>Â© 2026 Echoes of Gaza. <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" class="underline hover:text-gray-500">CC BY-NC-SA 4.0</a>.</p>
            <a href="https://echoesofgaza.org/admin.html" class="mt-4 md:mt-0 hover:text-gray-500 transition">Admin Portal</a>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            orderBy, 
            limit, 
            startAfter, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // --- CONFIGURATION ---
        // PASTE YOUR firebaseConfig HERE
          const firebaseConfig = {
      apiKey: "AIzaSyDWpXfcX0T3ceI4zSe5hADkcundb3TqqeM",
      authDomain: "echoes-of-gaza.firebaseapp.com",
      projectId: "echoes-of-gaza",
      storageBucket: "echoes-of-gaza.firebasestorage.app",
      messagingSenderId: "592151003023",
      appId: "1:592151003023:web:b3c7db040a0afb87a555fa"
    };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State
        let lastVisible = null;
        let isFetching = false;
        let allTags = new Set();
        const recordsList = document.getElementById('recordsList');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const tagFilter = document.getElementById('tagFilter');
        const sortFilter = document.getElementById('sortFilter');

        // Helper: Escape HTML for safety
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Helper: Create Record DOM Element
        function createRecordElement(doc) {
            const data = doc.data();
            const id = doc.id;
            
            // Fallbacks
            const title = data.title || "Untitled Record";
            const date = data.date || "Unknown Date";
            const source = data.source ? ` &mdash; ${data.source}` : "";
            const tag = data.tag || "Uncategorized";
            const previewUrl = data.drivePreviewUrl || "";
            
            // Track tag for filter
            if (tag) allTags.add(tag);

            const article = document.createElement('article');
            article.className = "group record-item"; // class for local filtering
            article.dataset.title = title.toLowerCase();
            article.dataset.tag = tag;
            article.dataset.source = (data.source || "").toLowerCase();

            // Structure
            article.innerHTML = `
                <div class="mb-4 flex items-baseline justify-between">
                    <span class="font-ui text-xs font-medium uppercase tracking-wider text-neutral-500 border border-neutral-800 px-2 py-1">${escapeHtml(tag)}</span>
                </div>
                
                <h3 class="font-heading text-2xl md:text-3xl text-white mb-2 leading-tight">${escapeHtml(title)}</h3>
                
                <div class="font-body text-ash italic mb-6">
                    ${escapeHtml(date)}${escapeHtml(source)}
                </div>

                <div class="w-12 h-px bg-blood mb-8"></div>

                <div class="relative w-full bg-neutral-900 border border-neutral-800">
                      <iframe 
                        src="${previewUrl}" 
                        allow="autoplay" 
                        loading="lazy" 
                        referrerpolicy="no-referrer" 
                        sandbox="allow-scripts allow-same-origin allow-popups" 
                        class="w-full aspect-[4/3] md:aspect-auto" 
                        style="height: 520px; border: none;"
                        title="Document Preview">
                    </iframe>
                </div>

                <div class="mt-3 text-right">
                    <a href="${previewUrl}" target="_blank" rel="noopener noreferrer" 
                       class="font-ui text-xs text-neutral-500 hover:text-blood uppercase tracking-widest transition-colors flex items-center justify-end gap-2 group-hover:underline decoration-blood underline-offset-4">
                        Open record in Drive
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="square" stroke-linejoin="miter" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                        </svg>
                    </a>
                </div>
            `;
            return article;
        }

        // Fetch Logic
        async function fetchRecords(reset = false) {
            if (isFetching) return;
            isFetching = true;
            
            if (reset) {
                recordsList.innerHTML = '';
                lastVisible = null;
                allTags.clear();
                updateTagFilter();
                loadingState.classList.remove('hidden');
                emptyState.classList.add('hidden');
                loadMoreBtn.classList.add('hidden');
            } else {
                loadMoreBtn.textContent = "Loading...";
            }

            try {
                const sortDirection = sortFilter.value === 'oldest' ? 'asc' : 'desc';
                
                let q = query(
                    collection(db, "primary_sources"),
                    where("status", "==", "approved"),
                    orderBy("approvedAt", sortDirection),
                    limit(12)
                );

                if (lastVisible) {
                    q = query(q, startAfter(lastVisible));
                }

                const querySnapshot = await getDocs(q);

                loadingState.classList.add('hidden');

                if (querySnapshot.empty && reset) {
                    emptyState.classList.remove('hidden');
                    isFetching = false;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const el = createRecordElement(doc);
                    recordsList.appendChild(el);
                });

                // Update pagination state
                lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
                
                // Show/Hide Load More
                if (querySnapshot.docs.length < 12) {
                    loadMoreBtn.classList.add('hidden');
                } else {
                    loadMoreBtn.classList.remove('hidden');
                    loadMoreBtn.textContent = "Load More Records";
                }

                // Update UI filters
                updateTagFilter();
                // Re-apply current client-side text filter if exists
                applyClientFilter();

            } catch (error) {
                console.error("Error fetching documents: ", error);
                recordsList.innerHTML += `<p class="text-red-900 font-ui text-sm text-center py-4">Error loading records. Ensure indexes are built.</p>`;
                loadingState.classList.add('hidden');
            } finally {
                isFetching = false;
            }
        }

        // Update Tag Dropdown
        function updateTagFilter() {
            // Keep current selection
            const currentVal = tagFilter.value;
            
            // Clear except first
            while (tagFilter.options.length > 1) {
                tagFilter.remove(1);
            }

            const sortedTags = Array.from(allTags).sort();
            sortedTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagFilter.appendChild(option);
            });

            // Restore selection if it still exists
            if (allTags.has(currentVal)) {
                tagFilter.value = currentVal;
            }
        }

        // Client-side Filter Logic (Search + Tag)
        // Note: Firestore text search is expensive/complex. 
        // We filter the *loaded* DOM elements for immediate feedback.
        function applyClientFilter() {
            const search = searchInput.value.toLowerCase();
            const tag = tagFilter.value;
            const items = document.querySelectorAll('.record-item');

            items.forEach(item => {
                const t = item.dataset.title;
                const s = item.dataset.source;
                const tg = item.dataset.tag;

                const matchesSearch = t.includes(search) || s.includes(search) || tg.toLowerCase().includes(search);
                const matchesTag = tag === "" || tg === tag;

                if (matchesSearch && matchesTag) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // Event Listeners
        loadMoreBtn.addEventListener('click', () => fetchRecords(false));
        
        searchInput.addEventListener('input', applyClientFilter);
        
        tagFilter.addEventListener('change', applyClientFilter);

        sortFilter.addEventListener('change', () => fetchRecords(true));

        // Initial Load
        document.addEventListener('DOMContentLoaded', () => {
            fetchRecords(true);
        });

    </script>
</body>
</html>
